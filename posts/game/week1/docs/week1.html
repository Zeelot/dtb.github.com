<!DOCTYPE html>  <html> <head>
<script>

	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-22566740-1']);
	_gaq.push(['_trackPageview']);

	(function() {
	if(window.location.host.toLowerCase() != "davidthomasbernal.com")
		return;
	
	var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

<title>week1.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               week1.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Game code for week 1 of <a href="/blog/2012/05/27/writing-your-first-game-using-html5-canvas/">Writing Your First Game Using HTML5 and Canvas</a>
The game code uses <a href="http://documentcloud.github.com/underscore/">underscore.js</a>, and 
some utility methods defined in <a href="week1-util.html">week1-util.js</a></p>

<p>Currently, we have 3 objects: <code>Game</code>, <code>Drawable</code>, and <code>Background</code> (which uses 
<code>Drawable</code> as its prototype.)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><code>Drawable</code> is the prototype for all objects that can exist in our world. It currently
provides in interface and some convenience methods to deal with drawing, and will
later also deal with collision detection and input handling.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Drawable</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Store the position and velocity of the current object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;state&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">vX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">vY</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The constructor takes an initial state of the object, and merges it in with the defaults</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;constructor&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">initialState</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Draw is called in the game loop, receiving the elapsed time <code>dT</code> and the game object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;draw&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dT</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Update the x and y coordinates using the current velocities. 
(This is sometimes called "integrating".)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">centroid</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">vX</span> <span class="o">*</span> <span class="nx">dT</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">vY</span> <span class="o">*</span> <span class="nx">dT</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Hand off to the actual drawing method. Descendant objects override this to implement
custom drawing logic.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">doDraw</span><span class="p">(</span><span class="nx">centroid</span><span class="p">,</span> <span class="nx">dT</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Finally update the state of the object.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>By default <code>Drawable</code> draws a circle at the current position</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;doDraw&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">centroid</span><span class="p">,</span> <span class="nx">dT</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">game</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">(</span><span class="nx">centroid</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">game</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">centroid</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
        <span class="nx">game</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>Background</code> is a <code>Drawable</code> that shows a scrolling background.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Background</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Drawable</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;image&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="s1">&#39;ready&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The constructor calls the constructor of <code>Drawable</code>, and fetches the background image.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;constructor&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">initialState</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">__super__</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;/posts/game/game-bg.jpg&#39;</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><code>doDraw</code> gets called by the logic in <code>Drawable</code>. In this case we override it to draw
the tiling background.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;doDraw&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">centroid</span><span class="p">,</span> <span class="nx">dT</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Don't begin drawing until the image has downloaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> 
            <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Make the background wrap around the canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span><span class="p">(</span><span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> 
            <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The tiling background is drawn in two slices. </p>

<p><code>drawImage</code> takes a rectangle from the source image stretching from the 
coordinates (sx, xy) to (sx + sw, sy + sh), and draws it to the canvas in 
a rectangle defined similarly.</p>

<p>We use this to draw a top slice and a bottom slice that move up in unison.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">game</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">,</span> 
            <span class="cm">/* sx */</span> <span class="mi">0</span><span class="p">,</span> 
            <span class="cm">/* sy */</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">naturalHeight</span> <span class="o">-</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> 
            <span class="cm">/* sw */</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">naturalWidth</span><span class="p">,</span> 
            <span class="cm">/* sh */</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> 
            <span class="cm">/* dx */</span> <span class="mi">0</span><span class="p">,</span> 
            <span class="cm">/* dy */</span> <span class="mi">0</span><span class="p">,</span> 
            <span class="cm">/* dw */</span> <span class="nx">game</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> 
            <span class="cm">/* dh */</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>

        <span class="nx">game</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">,</span> 
            <span class="cm">/* sx */</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* sy */</span> <span class="mi">0</span><span class="p">,</span> 
            <span class="cm">/* sw */</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">naturalWidth</span><span class="p">,</span>
            <span class="cm">/* sh */</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">naturalHeight</span> <span class="o">-</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> 
            <span class="cm">/* dx */</span> <span class="mi">0</span><span class="p">,</span>
            <span class="cm">/* dy */</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
            <span class="cm">/* dw */</span> <span class="nx">game</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
            <span class="cm">/* dh */</span> <span class="k">this</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">naturalHeight</span> <span class="o">-</span> <span class="nx">centroid</span><span class="p">.</span><span class="nx">y</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Define our game object. It has methods for setting up the rendering environment,
initializing objects, and running the game. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Game</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The speed that objects in the game move at.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;gameSpeed&#39;</span><span class="o">:</span> <span class="o">-</span><span class="p">.</span><span class="mi">15</span><span class="p">,</span>
    <span class="s1">&#39;constructor&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Initialize the lastPaint time, which we use to calculate the elapsed time (<code>dt</code>)
between frames.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">lastPaint</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Use two canvas elements to do double-buffering, which prevents the user from
seeing flickering as we draw the scene.</p>

<p><code>canvas</code> is the element currently used to display the scene,  <code>backbufferCanvas</code>
is a hidden element that we draw the scene to.</p>

<p>When the scene is finished drawing, we swap the two.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">canvii</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;#sample1 canvas&#39;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvii</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferCanvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvii</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferContext</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">backbufferCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>canvIdx</code> holds the index of the current display buffer. We flip this back and 
forth between 0 and 1 to swap the two canvases.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">canvIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Convenience methods for accessing the canvas size</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>We will put all the drawable objects in this array, later we loop over the 
array to draw the objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">objects</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">initBackground</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Draw a circle in the center as a placeholder for the player</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">centerObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Drawable</span><span class="p">({</span>
            <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">2</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">centerObj</span><span class="p">);</span>   </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p><code>_.bind</code> ensures that <code>this</code> always refers to the <code>Game</code> object when <code>draw</code>
is called from other contexts. We need this since <code>draw</code> is called from
<code>window.requestAnimationFrame</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_draw</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>These are used to track the framerate as a moving average.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">times</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;initBackground&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Initialize the background and add it to beginning of the objects array. It 
extends <code>Drawable</code>, so we can make it move just by
passing in an initial speed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="k">new</span> <span class="nx">Background</span><span class="p">({</span>
            <span class="nx">vY</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameSpeed</span><span class="p">,</span>
            <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span>
        <span class="p">}));</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p><code>draw</code> starts the game loop. It will continue to call itself using 
<a href="https://developer.mozilla.org/en/DOM/window.requestAnimationFrame"><code>requestAnimationFrame</code></a>
until the game is told to stop. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;_draw&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">draw</span><span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Calculate the amount of time since the loop last ran (<code>dT</code>), also save the
time that we started drawing, for performance tracking.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">dT</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastPaint</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">drawStart</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Clear the backbuffer, then ask the objects to draw themselves.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">obj</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">dT</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Increment the frame counter. Every 12 frames (5 times per second, since we 
run at 60 fps), calculate a new moving average framerate.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">frames</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">frames</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">fr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">frames</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Store the time drawing ended.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">lastPaint</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Draw the framerate.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferContext</span><span class="p">.</span><span class="nx">strokeText</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fr</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Finally, swap the backbuffer and the display buffer, which shows the new scene 
to the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">swapsies</span><span class="p">();</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Swaps the two canvas elements, and their contexts. Neat trick courtesy of <a href="http://stackoverflow.com/questions/2795269/does-html5-canvas-support-double-buffering">Fedor van Eldijk via StackOverflow</a></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s1">&#39;swapsies&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvii</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">canvIdx</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferCanvas</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvii</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvIdx</span><span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">canvIdx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvIdx</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferContext</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">backbufferCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;visible&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">backbufferCanvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">=</span> <span class="s1">&#39;hidden&#39;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>A quick and dirty shim for <code>requestAnimationFrame</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">=</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">||</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestAnimationFrame</span> <span class="o">||</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">mozRequestAnimationFrame</span> <span class="o">||</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">msRequestAnimationFrame</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Now simply start the game by initializing it and calling the draw method.</p>

<p>It can be stopped by setting <code>game.stop</code> to true.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">();</span>
<span class="nx">game</span><span class="p">.</span><span class="nx">draw</span><span class="p">();</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">getElementByid</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">game</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>That's all the code so far! </p>

<p><a href="/blog/2012/05/27/writing-your-first-game-using-html5-canvas/">↩ return to the post</a></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
